<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»£æ±æ­Œå¡«è©å¤§è³½ - é¦–é </title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
</head>
<body>

    <header class="navbar">
        <a href="index.html">ğŸ  å¡«è©å¤§å¸« Board Game</a>
    </header>

    <main class="container">
        
        <section class="card">
            <h2>ğŸ“œ éŠæˆ²è¦å‰‡</h2>
            <ul style="padding-left: 20px;">
                <li>æŠ½å–ä¸€å¼µ<strong>æ—‹å¾‹å¡</strong>ã€‚</li>
                <li>æƒç„ QR Code æˆ–è¼¸å…¥ç·¨è™Ÿã€‚</li>
                <li>è†è½æ—‹å¾‹ä¸¦å¡«è©ã€‚</li>
            </ul>
        </section>

        <section class="card">
            <h3>æœå°‹é¡Œç›®</h3>
            
            <div class="input-group">
                <input type="text" placeholder="è¼¸å…¥ç·¨è™Ÿ (ä¾‹å¦‚: 001)" id="questionInput">
                <button class="btn btn-primary" onclick="goToQuestionManual()">ç¢ºèªå‰å¾€</button>
            </div>

            <div class="text-center" style="margin: 15px 0; color: #aaa;">â€”â€” æˆ– â€”â€”</div>

            <button class="btn btn-secondary" onclick="openScanner()">
                ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒç„ QR Code
            </button>
        </section>

    </main>

    <div id="scannerModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeScanner()">&times;</button>
            <h3>æƒç„ QR Code</h3>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">è«‹å°‡ QR Code å°æº–é¡é ­</p>
            
            <div id="reader"></div>
            
            <p id="scanStatus" style="margin-top:10px; font-weight:bold; color:var(--primary-color)"></p>
        </div>
    </div>

    <script>
        // Global variable to store the scanner instance
        let html5QrcodeScanner = null;

        // --- 1. Manual Navigation ---
        function goToQuestionManual() {
            const input = document.getElementById('questionInput').value;
            if(input) window.location.href = 'question.html?id=' + input;
            else alert("è«‹è¼¸å…¥ç·¨è™Ÿï¼");
        }

        // --- 2. Open Modal & Start Camera ---
        function openScanner() {
            // Show the modal
            document.getElementById('scannerModal').style.display = 'flex';
            document.getElementById('scanStatus').innerText = "å•Ÿå‹•ç›¸æ©Ÿä¸­...";

            // Initialize Scanner
            // We use a small timeout to let the modal animation finish effectively
            setTimeout(() => {
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "reader", 
                    { 
                        fps: 10, 
                        qrbox: { width: 250, height: 250 }
                    },
                    false
                );
                
                // Start rendering the camera
                html5QrcodeScanner.render(onScanSuccess, onScanError);
                document.getElementById('scanStatus').innerText = "æ­£åœ¨æƒç„...";
            }, 100);
        }

        // --- 3. Close Modal & Stop Camera ---
        function closeScanner() {
            // Hide the modal
            document.getElementById('scannerModal').style.display = 'none';

            // Stop the camera to save battery
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().then(() => {
                    console.log("Camera stopped.");
                }).catch(error => {
                    console.error("Failed to clear scanner. ", error);
                });
            }
        }

        // --- 4. Success Logic ---
        function onScanSuccess(decodedText, decodedResult) {
            document.getElementById('scanStatus').innerText = "âœ… æˆåŠŸï¼è·³è½‰ä¸­...";
            
            // Stop scanning immediately so it doesn't scan twice
            html5QrcodeScanner.clear();

            if (decodedText.includes("question.html")) {
                window.location.href = decodedText; 
            } else {
                window.location.href = 'question.html?id=' + decodedText;
            }
        }

        function onScanError(errorMessage) {
            // Ignore errors (scanning empty space)
        }
    </script>
</body>
</html>